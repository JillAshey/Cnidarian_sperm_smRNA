---
title: "miRNA discovery"
author: "Jill Ashey"
date: "2025-09-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

### Apoc

Load data
```{r}
mirna_apoc <- read.table("../output/shortstack/apoc/trimmed_default/Results.txt", header = T)
```

Select data with miRNA == Y or known miRNA
```{r}
mirna_filtered_apoc <- mirna_apoc %>%
  filter(MIRNA == "Y" | !is.na(known_miRNAs)) %>%
 mutate(Length = End - Start) %>%
 mutate(mature_length = nchar(MajorRNA))
```

Only keep seqs that have length between 19-25
```{r}
mirna_filtered_apoc <- mirna_filtered_apoc %>%
  filter(mature_length >= 19) %>%
  filter(mature_length <= 25)
length(unique(mirna_filtered_apoc$MajorRNA))
```

There are two sequences that are repeats: UGGCUUGGAGUUCUAGUGAUUGA (corresponding to Cluster_595 and Cluster_598) and UUAAAGACGGAUCUGCACCCU (corresponding to Cluster_3127 and Cluster_3128). 

Should I remove one of the clusters of the repeats? They are very close to one another in the genome. For now, I am going to continue as is. 

Make a list of cluster names
```{r}
mirna_list_apoc <- mirna_filtered_apoc$Name
```

Read in apoc counts 
```{r}
counts_apoc <- read.table("../output/shortstack/apoc/trimmed_default/Counts.txt", header = T)
```

Filter apoc counts by the cluster names 
```{r}
counts_mirna_apoc <- counts_apoc[counts_apoc$Name %in% mirna_list_apoc, ]
```

Apoc 2 has orders of magnitude higher than the other reps...

Filter for miRNAs expressed in at least 3 out of 3 samples (count >= 5)
```{r}
counts_mirna_filt_apoc <- counts_mirna_apoc %>%
  rowwise() %>%
  mutate(
    samples_expressed = sum(c_across(starts_with("apoc_")) >= 5)
  ) %>%
  ungroup() %>%
  filter(samples_expressed >= 3)

mirna_list_counts_apoc <- counts_mirna_filt_apoc$Name
```

We are left with 7 miRNAs expressed. 

Filter apoc miRNA info by the remaining expressed cluster names 
```{r}
mirna_filtered_apoc <- mirna_filtered_apoc[mirna_filtered_apoc$Name %in% mirna_list_counts_apoc, ]
``` 

### Nvec

Load data
```{r}
mirna_nvec <- read.table("../output/shortstack/nvec/trimmed_default/Results.txt", header = T)
```

Select data with miRNA == Y or known miRNA
```{r}
mirna_filtered_nvec <- mirna_nvec %>%
  filter(MIRNA == "Y" | !is.na(known_miRNAs)) %>%
 mutate(Length = End - Start) %>%
 mutate(mature_length = nchar(MajorRNA))
```

Only keep seqs that have length between 19-25
```{r}
mirna_filtered_nvec <- mirna_filtered_nvec %>%
  filter(mature_length >= 19) %>%
  filter(mature_length <= 25)
length(unique(mirna_filtered_nvec$MajorRNA))
```

There are two repeat sequences present: AACUGAUUUUUGGAAACUGGCU (corresponding to Cluster_1954, Cluster_1959, and Cluster_1961) and UGACAGAAGAUAGAAGCGCUG (corresponding to Cluster_2470 and Cluster_2471). 

Make a list of cluster names
```{r}
mirna_list_nvec <- mirna_filtered_nvec$Name
```

Read in nvec counts 
```{r}
counts_nvec <- read.table("../output/shortstack/nvec/trimmed_default/Counts.txt", header = T)
```

Filter nvec counts by the cluster names 
```{r}
counts_mirna_nvec <- counts_nvec[counts_nvec$Name %in% mirna_list_nvec, ]
```

Filter for miRNAs expressed in at least 3 out of 4 samples (count >= 5)
```{r}
counts_mirna_filt_nvec <- counts_mirna_nvec %>%
  rowwise() %>%
  mutate(
    samples_expressed = sum(c_across(starts_with("nvec_")) >= 5)
  ) %>%
  ungroup() %>%
  filter(samples_expressed >= 3)

mirna_list_counts_nvec <- counts_mirna_filt_nvec$Name
```

Should I condense Cluster_1954, Cluster_1959, and Cluster_1961 into one miRNA? They are all nve-miR-9415. 

We are left with 14 miRNAs expressed. 

Filter nvec miRNA info by the remaining expressed cluster names 
```{r}
mirna_filtered_nvec <- mirna_filtered_nvec[mirna_filtered_nvec$Name %in% mirna_list_counts_nvec, ]
``` 

### Ahya

Load data
```{r}
mirna_ahya <- read.table("../output/shortstack/ahya/trimmed_default/Results.txt", header = T)
```

Select data with miRNA == Y or known miRNA
```{r}
mirna_filtered_ahya <- mirna_ahya %>%
  filter(MIRNA == "Y" | !is.na(known_miRNAs)) %>%
 mutate(Length = End - Start) %>%
 mutate(mature_length = nchar(MajorRNA))
```

Only keep seqs that have length between 19-25
```{r}
mirna_filtered_ahya <- mirna_filtered_ahya %>%
  filter(mature_length >= 19) %>%
  filter(mature_length <= 25)
length(unique(mirna_filtered_ahya$MajorRNA))
```

There are several duplicate miRNAs. 

Remove `efu-miR-9341` -- it is mapping multiple times across the genome and corresponds to a bat miRNA.
```{r}
mirna_filtered_ahya <- mirna_filtered_ahya %>%
  filter(!known_miRNAs == "efu-miR-9341")
length(unique(mirna_filtered_ahya$MajorRNA))
```

Now there is one duplicate miRNA sequence: UCUGCGUUAUCGGUGAAAUUGU (corresponding to Cluster_1517 and Cluster_1518).

Make a list of cluster names
```{r}
mirna_list_ahya <- mirna_filtered_ahya$Name
```

Read in ahya counts 
```{r}
counts_ahya <- read.table("../output/shortstack/ahya/trimmed_default/Counts.txt", header = T)
```

Filter ahya counts by the cluster names 
```{r}
counts_mirna_ahya <- counts_ahya[counts_ahya$Name %in% mirna_list_ahya, ]
```

Filter for miRNAs expressed in at least 3 out of 4 samples (count >= 5)
```{r}
counts_mirna_filt_ahya <- counts_mirna_ahya %>%
  rowwise() %>%
  mutate(
    samples_expressed = sum(c_across(starts_with("ahya_")) >= 5)
  ) %>%
  ungroup() %>%
  filter(samples_expressed >= 3)
```
